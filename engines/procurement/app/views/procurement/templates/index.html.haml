%h1= _('Templates')

.fa.fa-sitemap
= _('Group')
%br
%h4= @group

= form_tag nil, remote: true do

  - @group.template_categories.build
  - @template_categories.each do |template_category|
    .panel.panel-default
      .panel-heading
        %i.fa.fa-cube
        - if template_category.id
          %input{type: :hidden, name: "template_categories[#{template_category.object_id}][id]", value: template_category.id}
        = succeed ':' do
          = _('Category')
        %input{name: "template_categories[#{template_category.object_id}][name]", value: template_category.name}
      %table.table.table-striped
        %thead
          %tr
            -#%th.col-xs-3= _('Group')
            %th.col-xs-4= _('Description')
            %th.col-xs-4= "%s %s %s" % [_('Price'), MoneyRails.default_currency, _('incl. VAT')]
            %th.col-xs-4= _('Supplier')
        %tbody
          - template_category.templates.each do |template|
            %tr
              %input{type: :hidden, name: "template_categories[#{template_category.object_id}][templates_attributes][][id]", value: template.id}
              -#%td
                %select.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][group_id]"}
                  %option{value: template.group_id, selected: true}= template.group
              %td
                %input.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][model_description]", placeholder: _('Model name'), value: template.model_description}
              %td
                %input.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][price]", type: :number, min: 0, value: template.price, placeholder: ("%s %s" % [_('Price'), _('incl. VAT')]), autocomplete: :off}
              %td
                %input.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][supplier]", placeholder: _('Supplier'), value: template.supplier}

          %tr
            -#%td
              %select.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][group_id]"}
                %option
                - Procurement::Group.all.each do |group|
                  %option{value: group.id}= group
            %td
              %input.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][model_description]", placeholder: _('Model name')}
            %td
              %input.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][price]", type: :number, min: 0, placeholder: ("%s %s" % [_('Price'), _('incl. VAT')]), autocomplete: :off}
            %td
              %input.form-control{name: "template_categories[#{template_category.object_id}][templates_attributes][][supplier]", placeholder: _('Supplier')}
            %td
        %tfoot
          %tr
            %td.h3{colspan: 4}
              %i.fa.fa-plus-circle

  .text-right
    %button.btn.btn-success{type: :submit}
      %i.fa.fa-check
      = _('Save')

:scss
  form .fa-plus-circle {
    cursor: pointer;
    color: #5cb85c;
  }

:coffeescript
  $(document).ready ->
    initAutocompletes = ->
      $("input[name*='[templates_attributes][][model_description]']").autocomplete
        minLength: 3
        source: ( request, response )->
          $.ajax
            url: "/procurement/models.json"
            dataType: "json"
            data:
              search_term: request.term
            success: ( data )->
              response( data )
        select: ( event, ui )->
          $(this).val( ui.item.name )
          false
      .each ->
        $(this).data('ui-autocomplete')._renderItem = ( ul, item )->
          $( "<li>" ).append( "<a>" + item.name + "</a>" ).appendTo( ul )

      $("input[name*='[templates_attributes][][supplier]']").autocomplete
        minLength: 3
        source: ( request, response )->
          $.ajax
            url: '/procurement/suppliers.json'
            dataType: "json"
            data:
              search_term: request.term
            success: ( data )->
              response( data )
        select: ( event, ui )->
          $(this).val( ui.item.name )
          false
      .each ->
        $(this).data('ui-autocomplete')._renderItem = ( ul, item )->
          $( "<li>" ).append( "<a>" + item.name + "</a>" ).appendTo( ul )

    do initAutocompletes

    $('tfoot').on 'click', '.fa-plus-circle', ->
      target_el = $(this).closest('tfoot').prev('tbody').find('tr:last-child')
      cloned_el = target_el.clone()
      cloned_el.find('input').val('')
      cloned_el.insertAfter(target_el)
      do initAutocompletes
      false

    $("form").on("ajax:success", (e, data, status, xhr) ->
      location.reload()
    ).on "ajax:error", (e, xhr, status, error) ->
      errors = ''
      for error in xhr.responseJSON
        errors += '<li>' + error + '</li>'
      $("#flash").html '<ul class="alert alert-danger" style="padding-left: 2em;">' + errors + '</ul>'
