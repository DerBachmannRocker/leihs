%h1
  %i.fa.fa-shopping-cart
  = _('Categories')

= form_tag nil, remote: true, id: "accordion" do

  - @categories.each do |category|
    .panel.panel-default
      .panel-heading.collapsed(data-toggle="collapse" data-parent="#accordion" href="#collapse_#{category.id}")
        .row
          .col-xs-11
            %span.toggler
              %i.fa.fa-caret-right
            %i.fa.fa-cube
            - if category.id
              %input{type: :hidden, name: "categories[#{category.object_id}][id]", value: category.id}
              %input{type: :hidden, name: "categories[#{category.object_id}][_destroy]"}
            %label
              = succeed ':' do
                = _('Main category')
              %input{name: "categories[#{category.object_id}][name]", value: category.name}
          .col-xs-1.text-right{style: 'font-size: 1.6em'}
            - if category.can_destroy?
              %i.fa.fa-minus-circle{title: _("Delete main category "), data: {toggle: 'tooltip'}}

      .panel-body(id="collapse_#{category.id}" class="panel-collapse collapse" role="tabpanel")
        .row
          .col-xs-4
            %h4= _('Budget limits')
            - Procurement::BudgetPeriod.order(end_date: :desc).each do |budget_period|
              - budget_limit = category.budget_limits.find_or_initialize_by(budget_period_id: budget_period.id)
              = fields_for :budget_limits, budget_limit do |ff|
                - if budget_limit.persisted?
                  %input{type: :hidden, name: "categories[#{category.object_id}][budget_limits_attributes][#{budget_limit.object_id}][id]", value: ff.object.id}
                .row
                  .col-sm-4
                    %input{type: :hidden, name: "categories[#{category.object_id}][budget_limits_attributes][#{budget_limit.object_id}][budget_period_id]", value: ff.object.budget_period_id}
                    = budget_period
                  .col-sm-8
                    %input.form-control{type: :number, name: "categories[#{category.object_id}][budget_limits_attributes][#{budget_limit.object_id}][amount]", min: 0, step: 1, placeholder: _('Budget'), autocomplete: :off, value: ff.object.amount.to_i}

          .col-xs-8
            %h4= _('Subcategories')
            %table.table
              %thead
                %tr.row
                  %th.col-xs-5= _('Name')
                  %th.col-xs-5= _('Inspectors')
                  %th.col-xs-2
              %tbody
                - category.children.each do |subcategory|
                  %tr.row
                    %td.col-xs-5
                      %input{type: :hidden, name: "categories[#{category.object_id}][children_attributes][#{subcategory.object_id}][id]", value: subcategory.id}
                      %input{type: :hidden, name: "categories[#{category.object_id}][children_attributes][#{subcategory.object_id}][_destroy]"}
                      %input.form-control{name: "categories[#{category.object_id}][children_attributes][#{subcategory.object_id}][name]", placeholder: _('Name'), value: subcategory.name}
                    %td.col-xs-5
                      %input.form-control{name: "categories[#{category.object_id}][children_attributes][#{subcategory.object_id}][inspector_ids]", multiple: true, placeholder: _("Name of the inspector"), autocomplete: :off, data: {current: subcategory.inspectors.to_json(only: [:id, :firstname, :lastname])}}
                    %td.col-xs-2.text-right
                      - if subcategory.can_destroy?
                        %i.fa.fa-minus-circle{title: _("Delete subcategory"), data: {toggle: 'tooltip'}}
                %tr.row
                  %td.col-xs-5
                    %input.form-control{name: "categories[#{category.object_id}][children_attributes][new][name]", placeholder: _('Name')}
                  %td.col-xs-5
                    %input.form-control{name: "categories[#{category.object_id}][children_attributes][new][inspector_ids]", multiple: true, placeholder: _("Name of the inspector"), autocomplete: :off}
                  %td.col-xs-2.text-right
                    %i.fa.fa-minus-circle{title: _("Delete subcategory "), data: {toggle: 'tooltip'}}
              %tfoot
                %tr
                  %td.h3{colspan: 3}
                    %i.fa.fa-plus-circle{title: _('Add new subcategory'), data: {toggle: 'tooltip'}}

  = render partial: 'new_category'
  .h3
    %i.fa.fa-plus-circle{title: _('Add new main category'), data: {toggle: 'tooltip'}}

  .row
    .col-xs-12
      = render partial: 'layouts/procurement/flash', :locals => {:flash => flash}
  .text-right
    %button.btn.btn-success{type: :submit}
      %i.fa.fa-check
      = _('Save')

:scss
  #new_main_category {
    display: none;
  }

:coffeescript
  $(document).ready ->
    $('form > .h3').on 'click', '.fa-plus-circle', ->
      $('#new_main_category').show()
      $(this).hide()
      false

    $('tfoot').on 'click', '.fa-plus-circle', ->
      target_el = $(this).closest('tfoot').prev('tbody').find('tr:last-child')
      cloned_el = target_el.clone()
      cloned_el.find('input').val('')
      cloned_el.insertAfter(target_el)
      $(this).hide()
      false

    $('.panel-heading').on 'click', '.fa-minus-circle', ->
      panel_el = $(this).closest('.panel')
      target_el = panel_el.find(".panel-heading input[name*='[_destroy]']")
      if target_el.val() == '1'
        target_el.val('').change()
        panel_el.removeClass('panel-danger').addClass('panel-default')
      else
        target_el.val('1').change()
        panel_el.removeClass('panel-default').addClass('panel-danger')
      false

    $('tbody').on 'click', '.fa-minus-circle', ->
      row_el = $(this).closest('tr')
      target_el = row_el.find("input[name*='[_destroy]']")
      if target_el.val() == '1'
        target_el.val('').change()
        row_el.removeClass('bg-danger')
      else
        target_el.val('1').change()
        row_el.addClass('bg-danger')
      false

    $('.panel').on('click', '.panel-heading:not(.collapsed) input', (e)->
      e.stopPropagation()
    ).on('show.bs.collapse', '.panel-collapse', ()->
      $(this).closest('.panel').find('.panel-heading .toggler').html('<i class="fa fa-caret-down"></i>')
    ).on('hidden.bs.collapse', '.panel-collapse', ()->
      $(this).closest('.panel').find('.panel-heading .toggler').html('<i class="fa fa-caret-right"></i>')
    )

    $('form').on('ajax:success', (e, data, status, xhr) ->
      location.reload()
    ).on 'ajax:error', (e, xhr, status, error) ->
      errors = ''
      for error in xhr.responseJSON
        errors += '<li>' + error + '</li>'
      $('.flash').html '<ul class="alert alert-danger" style="padding-left: 2em;">' + errors + '</ul>'

    $('form').on 'change', ->
      $('.flash').hide()

    $("input[name*='[inspector_ids]']").each (i, el)->
      $(el).tokenInput '/procurement/users.json',
        minChars: 3
        queryParam: 'search_term'
        propertyToSearch: "lastname"
        resultsFormatter: (item)->
          "<li>" + item.firstname + " " + item.lastname + "</li>"
        tokenFormatter: (item)->
          "<li>" + item.firstname + " " + item.lastname + "</li>"
        prePopulate: $(el).data('current')
        preventDuplicates: true
        hintText: "#{_('Type in a search term')}"
        noResultsText: "#{_('No results')}"
        searchingText: "#{_('Searching...')}"
        #theme: 'facebook'

